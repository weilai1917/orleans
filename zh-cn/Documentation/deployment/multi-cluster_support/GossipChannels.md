---
layout: page
title: Multi-Cluster Communication
---

## 多集群通信

网络的配置必须使任何Orleanssilos都可以通过TCP/IP连接到任何其他Orleanssilos，而不管它位于世界的哪个位置。具体如何实现这一点不在Orleans的范围内，因为这取决于silos的部署方式和地点。

例如，在windows azure上，我们可以使用vnets连接一个区域内的多个部署，并使用网关连接不同区域的vnets。

### 群集ID

每个群集都有自己唯一的群集ID。必须在全局配置中指定群集ID。

群集ID不能为空，也不能包含逗号。此外，如果使用azure表存储，则群集ID不能包含行键(/，\\，，？)所禁止的字符。是的。

我们建议对集群id使用非常短的字符串，因为集群id经常传输，并且可能由一些日志视图提供程序存储在存储器中。

### 群集网关

每个集群都会自动指定其活动silos的一个子集作为*群集网关*是的。群集网关直接向其他群集公布其IP地址，因此可以充当“第一联系人”。默认情况下，最多10个silos(或配置为`MaxMultiClusterGateways系列`)被指定为群集网关。

不同集群中的silos之间的通信*不*总是经过一个关口。一旦一个silos知道并缓存了一个Grains激活的位置(无论在哪个集群中)，它就直接向该silos发送消息，即使silos不是集群网关。

### 八卦

gossip是集群共享配置和状态信息的机制。顾名思义，八卦是分散的、双向的：每个silos直接与其他silos通信，无论是在同一个集群中还是在其他集群中，以便在两个方向上交换信息。

**内容**是的。八卦包含以下部分或全部信息：

-   当前时间戳[多群集配置](MultiClusterConfiguration.md)是的。
-   包含有关群集网关信息的字典。密钥是silos地址，该值包含(1)时间戳，(2)群集ID和(3)状态，状态可以是活动的，也可以是非活动的。

**快速和慢速传播**是的。当网关更改其状态，或当操作员注入新配置时，此八卦信息将立即发送到所有silos、集群和八卦频道。这种情况发生得很快，但并不可靠。如果消息由于任何原因(如竞争、套接字中断、silos故障)而丢失，我们定期的背景八卦会确保信息最终传播，尽管传播速度会更慢。所有信息最终都会在任何地方传播，并且对偶尔的消息丢失和失败具有很强的弹性。

所有八卦数据都有时间戳，这样可以确保更新的信息替换旧的信息，而不管消息的相对时间。例如，较新的多群集配置替换较旧的配置，而有关网关的较新信息替换有关该网关的较旧信息。有关八卦数据表示的更多详细信息，请参见`多簇数据`上课。它有一个`合并`方法，该方法结合八卦数据，使用时间戳解决冲突。

### 八卦频道

当silos首次启动或故障后重新启动时，它需要有一种方法**揭发流言蜚语**是的。这是*八卦频道*，可以在[silos配置](SiloConfiguration.md)是的。启动时，一个Silo从八卦频道获取所有信息。启动后，silos每隔30秒或任何配置为`背景消息间隔`是的。每次它与从所有群集网关和八卦频道中随机选择的伙伴同步八卦信息。

笔记：

-   虽然不是严格要求，但我们建议始终在不同的区域配置至少两个八卦频道，以获得更好的可用性。

-   与八卦频道沟通的延迟并不重要。

-   只要serviceid guid(由它们各自的配置指定)是不同的，多个不同的服务就可以使用相同的八卦频道而不受干扰。

-   没有严格要求所有silos使用相同的八卦频道，只要频道足够让silos在启动时最初与“八卦社区”连接。但是，如果八卦频道不是silos配置的一部分，并且silos是网关，则它不会将其状态更新推送到频道(快速传播)，因此在通过周期性背景八卦(慢速传播)到达频道之前，可能需要更长的时间。

#### 基于azure表的八卦频道

我们已经实现了一个基于azure表的八卦频道。配置指定用于azure帐户的标准连接字符串。例如，一个配置可以使用单独的azure存储帐户指定两个八卦频道`美国`和`欧洲`具体如下：

```csharp
var silo = new SiloHostBuilder()
  [...]
  .Configure<MultiClusterOptions>(options => 
  {
    [...]
    options.GossipChannels.Add("AzureTable", "DefaultEndpointsProtocol=https;AccountName=usa;AccountKey=...");
    options.GossipChannels.Add("AzureTable", "DefaultEndpointsProtocol=https;AccountName=europe;AccountKey=...")
    [...]
  })
  [...]
```

多个不同的服务可以使用相同的八卦频道而不受干扰，只要它们各自配置指定的serviceid guid是不同的。

#### 其他八卦频道实现

我们正在研究其他八卦频道提供商，类似于如何为许多不同的存储后端打包成员资格和提醒。
